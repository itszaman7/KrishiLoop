{% extends "base.html" %}
{% block content %}
<div class="container-fluid">
  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <h5>Select Batch</h5>
        </div>
        <div class="card-body">
          <select class="form-select" id="batchSelector" required>
            <option value="">Select a batch for training</option>
            {% for batch in batches %}
            <option value="{{ batch.id }}">{{ batch.name }} ({{ batch.total_items }} items)</option>
            {% endfor %}
          </select>
        </div>
      </div>
    </div>
  </div>

  <div id="workspaceContent" style="display: none;">
    <div class="row">
      <!-- Input Selection Card -->
      <div class="col-sm-12">
        <div class="card">
          <div class="card-header">
            <h5>{{ breadcrumb.parent }}</h5>
            <span>Select your input method</span>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <!-- Camera Input Option -->
              <div class="col-md-4">
                <div class="card-wrapper border rounded-3 h-100">
                  <div class="row g-1">
                    <div class="col-12 text-center p-3">
                      <i class="fa-solid fa-camera fa-2x mb-3"></i>
                      <h6>Camera Capture</h6>
                      <p>Use connected webcam or camera</p>
                      <button class="btn btn-primary" id="startCamera">Start Camera</button>
                    </div>
                  </div>
                </div>
              </div>
              <!-- Screen Capture Option -->
              <div class="col-md-4">
                <div class="card-wrapper border rounded-3 h-100">
                  <div class="row g-1">
                    <div class="col-12 text-center p-3">
                      <i class="fa-solid fa-desktop fa-2x mb-3"></i>
                      <h6>Screen Capture</h6>
                      <p>Share and capture your screen</p>
                      <button class="btn btn-primary" id="startScreen">Share Screen</button>
                    </div>
                  </div>
                </div>
              </div>
              <!-- File Upload Option -->
              <div class="col-md-4">
                <div class="card-wrapper border rounded-3 h-100">
                  <div class="row g-1">
                    <div class="col-12 text-center p-3">
                      <i class="fa-solid fa-upload fa-2x mb-3"></i>
                      <h6>Upload Image</h6>
                      <p>Upload existing image file</p>
                      <input type="file" class="d-none" id="fileInput" accept="image/*">
                      <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">Choose File</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Capture Interface Card (Initially Hidden) -->
      <div class="col-sm-12 mt-4" id="captureInterface" style="display: none;">
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5>Capture Interface</h5>
            <button class="btn btn-danger btn-sm" id="closeCapture">
              <i class="fa-solid fa-times me-2"></i>Close
            </button>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-12">
                <!-- Stream Preview -->
                <div class="bg-dark rounded mb-3">
                  <video id="preview" autoplay muted class="w-100" style="max-height: 60vh; object-fit: contain;"></video>
                </div>
                <!-- Device Selection -->
                <div class="mb-3">
                  <select class="form-select" id="deviceSelect">
                    <option value="">Loading devices...</option>
                  </select>
                </div>
                <!-- Controls -->
                <div class="d-flex justify-content-between">
                  <button class="btn btn-primary" id="captureImage">
                    <i class="fa-solid fa-camera me-2"></i>Take Screenshot
                  </button>
                  <button class="btn btn-danger" id="stopCapture">
                    <i class="fa-solid fa-stop me-2"></i>Stop
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Image Preview Card (Initially Hidden) -->
      <div class="col-sm-12 mt-4" id="imagePreview" style="display: none;">
        <div class="card">
          <div class="card-header">
            <h5>Captured Images</h5>
          </div>
          <div class="card-body">
            <div class="row" id="previewGallery">
              <!-- Images will be added here dynamically -->
            </div>
          </div>
        </div>
      </div>

      <!-- Add this button after the image preview card -->
      <div class="col-sm-12 mt-4" id="processButtonContainer" style="display: none;">
        <div class="card">
          <div class="card-body text-center">
            <button class="btn btn-primary" id="processImages">
              <i class="fa-solid fa-microscope me-2"></i>Process Images with AI
            </button>
          </div>
        </div>
      </div>

      <!-- Add this div for loading ImageDetector results -->
      <div id="detectionResultsContainer"></div>

      <!-- Detection Results Card (Initially Hidden) -->
      <div class="col-sm-12 mt-4" id="detectionResults" style="display: none;">
        <div class="card">
          <div class="card-header">
            <h5>Orange Detection Results</h5>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-6">
                <div class="card">
                  <div class="card-header">
                    <h6>Fresh Orange Detection</h6>
                  </div>
                  <div class="card-body">
                    <img id="freshResult" class="img-fluid" src="" alt="Fresh orange detection">
                    <div id="freshStats" class="mt-3"></div>
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="card">
                  <div class="card-header">
                    <h6>Bad Orange Detection</h6>
                  </div>
                  <div class="card-body">
                    <img id="badResult" class="img-fluid" src="" alt="Bad orange detection">
                    <div id="badStats" class="mt-3"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scriptcontent %}
<script>
  // Global variables
  let selectedBatchId = null;
  let mediaStream = null;

  // Get DOM elements
  const workspaceContent = document.getElementById('workspaceContent');
  const batchSelector = document.getElementById('batchSelector');
  const captureInterface = document.getElementById('captureInterface');
  const imagePreview = document.getElementById('imagePreview');
  const previewGallery = document.getElementById('previewGallery');
  const detectionResults = document.getElementById('detectionResults');
  const processButtonContainer = document.getElementById('processButtonContainer');

  // Batch selection handler
  batchSelector.addEventListener('change', function() {
    selectedBatchId = this.value;
    console.log('Selected Batch ID:', selectedBatchId);
    
    if (selectedBatchId) {
      workspaceContent.style.display = 'block';
    } else {
      workspaceContent.style.display = 'none';
      stopCapture();
    }
  });

  // Screen Share handler
  document.getElementById('startScreen').addEventListener('click', async () => {
    if (!selectedBatchId) {
      Swal.fire({
        title: "Error!",
        text: "Please select a batch first",
        icon: "error",
        buttonsStyling: false,
        customClass: { confirmButton: 'btn btn-primary' }
      });
      return;
    }

    try {
      mediaStream = await navigator.mediaDevices.getDisplayMedia({ video: true });
      const video = document.getElementById('preview');
      video.srcObject = mediaStream;
      captureInterface.style.display = 'block';
      processButtonContainer.style.display = 'block';
    } catch (error) {
      console.error('Error sharing screen:', error);
      Swal.fire({
        title: "Error!",
        text: "Failed to share screen",
        icon: "error",
        buttonsStyling: false,
        customClass: { confirmButton: 'btn btn-primary' }
      });
    }
  });

  // Camera handler
  document.getElementById('startCamera').addEventListener('click', async () => {
    if (!selectedBatchId) {
      Swal.fire({
        title: "Error!",
        text: "Please select a batch first",
        icon: "error",
        buttonsStyling: false,
        customClass: { confirmButton: 'btn btn-primary' }
      });
      return;
    }

    try {
      mediaStream = await navigator.mediaDevices.getUserMedia({ video: true });
      const video = document.getElementById('preview');
      video.srcObject = mediaStream;
      captureInterface.style.display = 'block';
      processButtonContainer.style.display = 'block';
    } catch (error) {
      console.error('Error accessing camera:', error);
      Swal.fire({
        title: "Error!",
        text: "Failed to access camera",
        icon: "error",
        buttonsStyling: false,
        customClass: { confirmButton: 'btn btn-primary' }
      });
    }
  });

  // File upload handler
  document.getElementById('fileInput').addEventListener('change', (event) => {
    if (!selectedBatchId) {
      Swal.fire({
        title: "Error!",
        text: "Please select a batch first",
        icon: "error",
        buttonsStyling: false,
        customClass: { confirmButton: 'btn btn-primary' }
      });
      return;
    }

    const file = event.target.files[0];
    if (file) {
      const formData = new FormData();
      formData.append('image', file);
      formData.append('batch_id', selectedBatchId);

      // Show loading state
      Swal.fire({
        title: 'Uploading...',
        text: 'Please wait',
        allowOutsideClick: false,
        showConfirmButton: false,
        didOpen: () => {
          Swal.showLoading();
        }
      });

      fetch('/upload-image', {
        method: 'POST',
        body: formData
      })
      .then(response => response.json())
      .then(data => {
        Swal.close();
        if (data.success) {
          // Add to gallery
          const col = document.createElement('div');
          col.className = 'col-sm-6 col-md-4 col-xl-3 mb-3';
          col.innerHTML = `
            <div class="card">
              <img src="/static/uploads/${data.filename}" class="card-img-top" alt="Uploaded image">
              <div class="card-body">
                <h6 class="card-title">${data.filename}</h6>
                <p class="card-text">
                  <small class="text-muted">
                    Uploaded: ${new Date().toLocaleString()}
                  </small>
                </p>
              </div>
            </div>
          `;
          previewGallery.insertBefore(col, previewGallery.firstChild);
          imagePreview.style.display = 'block';
          processButtonContainer.style.display = 'block';
        }
      })
      .catch(error => {
        Swal.fire({
          title: "Error!",
          text: "Failed to upload image",
          icon: "error",
          buttonsStyling: false,
          customClass: { confirmButton: 'btn btn-primary' }
        });
      });
    }
  });

  // Stop capture handler
  document.getElementById('stopCapture').addEventListener('click', stopCapture);
  document.getElementById('closeCapture').addEventListener('click', stopCapture);

  function stopCapture() {
    if (mediaStream) {
      mediaStream.getTracks().forEach(track => track.stop());
      mediaStream = null;
    }
    const video = document.getElementById('preview');
    video.srcObject = null;
    captureInterface.style.display = 'none';
  }

  // Process images handler
  document.getElementById('processImages').addEventListener('click', async () => {
    const images = document.querySelectorAll('#previewGallery img');
    if (images.length === 0) {
      Swal.fire({
        title: "Error!",
        text: "No images to process",
        icon: "error",
        buttonsStyling: false,
        customClass: { confirmButton: 'btn btn-primary' }
      });
      return;
    }

    // Show loading state
    Swal.fire({
      title: 'Processing Images...',
      text: 'Please wait while we process your images',
      allowOutsideClick: false,
      showConfirmButton: false,
      didOpen: () => {
        Swal.showLoading();
      }
    });

    try {
      // Process each image
      for (const img of images) {
        await processImage(img.src);
      }
      
      Swal.close();
    } catch (error) {
      Swal.fire({
        title: "Error!",
        text: error.message || "Failed to process images",
        icon: "error",
        buttonsStyling: false,
        customClass: { confirmButton: 'btn btn-primary' }
      });
    }
  });

  // Add the processImage function
  async function processImage(imageSrc) {
    try {
      if (!selectedBatchId) {
        throw new Error('Please select a batch first');
      }

      // Convert image URL to blob
      const response = await fetch(imageSrc);
      const imageBlob = await response.blob();

      const formData = new FormData();
      formData.append('image', imageBlob);
      formData.append('batch_id', selectedBatchId);

      const processResponse = await fetch('/detect-oranges', {
        method: 'POST',
        body: formData
      });

      const result = await processResponse.json();

      if (!result.success) {
        throw new Error(result.error || 'Failed to process image');
      }

      // Update detection results display
      const detectionResults = document.getElementById('detectionResults');
      
      // Create or update results container
      let resultsHtml = '<div class="row">';
      
      if (result.fresh_image) {
        resultsHtml += `
          <div class="col-md-6">
            <div class="card">
              <div class="card-header">
                <h6 class="mb-0">Fresh Oranges</h6>
              </div>
              <div class="card-body">
                <img src="${result.fresh_image}" class="img-fluid mb-2" alt="Fresh oranges">
                <div class="mt-2">
                  <p class="mb-1">Count: ${result.fresh_count}</p>
                  <p class="mb-0">Confidence: ${result.fresh_confidence}%</p>
                </div>
              </div>
            </div>
          </div>
        `;
      }

      if (result.bad_image) {
        resultsHtml += `
          <div class="col-md-6">
            <div class="card">
              <div class="card-header">
                <h6 class="mb-0">Bad Oranges</h6>
              </div>
              <div class="card-body">
                <img src="${result.bad_image}" class="img-fluid mb-2" alt="Bad oranges">
                <div class="mt-2">
                  <p class="mb-1">Count: ${result.bad_count}</p>
                  <p class="mb-0">Confidence: ${result.bad_confidence}%</p>
                </div>
              </div>
            </div>
          </div>
        `;
      }

      resultsHtml += '</div>';
      
      detectionResults.innerHTML = resultsHtml;
      detectionResults.style.display = 'block';

    } catch (error) {
      console.error('Error processing image:', error);
      throw error;
    }
  }

  // Rest of your existing code...
</script>
{% endblock %}

{% block css %}
<style>
/* Reset modal positioning */
.modal-dialog {
    margin: 1.75rem auto;
    max-width: 800px;
    position: relative;
}

/* Fix modal stacking and scrolling */
.modal {
    position: fixed;
    top: 0;
    left: 0;
    z-index: 9999 !important; /* Increased z-index */
    width: 100%;
    height: 100%;
    overflow-x: hidden;
    overflow-y: auto;
    outline: 0;
}

/* Ensure backdrop is behind modal but above other content */
.modal-backdrop {
    z-index: 9998 !important; /* Just below modal */
}

/* Fix modal content overflow */
.modal-content {
    position: relative;
    width: 100%;
    max-height: calc(100vh - 3.5rem);
    margin: auto;
}

/* Ensure video container stays within bounds */
.modal-body {
    position: relative;
    max-height: calc(100vh - 12rem);
    overflow-y: auto;
}

/* Fix page-body-wrapper stacking */
.page-body-wrapper {
    z-index: auto !important;
}

/* Fix header stacking */
.page-header {
    z-index: 8 !important;
}

/* Fix sidebar stacking */
.sidebar-wrapper {
    z-index: 7 !important;
}

/* Ensure modal appears on top of everything */
.modal {
    z-index: 1060 !important;
}

/* Center modal vertically and horizontally */
.modal-dialog-centered {
    display: flex;
    align-items: center;
    min-height: calc(100% - 1rem);
}

/* Ensure modal content fits within viewport */
.modal-content {
    max-height: 90vh;
    overflow: hidden;
}

/* Make video container responsive */
.video-container {
    position: relative;
    padding-bottom: 56.25%; /* 16:9 aspect ratio */
    height: 0;
    overflow: hidden;
}

.video-container video {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: contain;
}

/* Ensure controls are always visible */
.modal-body .controls {
    background: rgba(255, 255, 255, 0.9);
    border-top: 1px solid #dee2e6;
}

/* Fix modal backdrop */
.modal-backdrop {
    z-index: 1050 !important;
}

/* Fix SweetAlert2 button styling */
.swal2-confirm.btn.btn-primary {
    color: #fff !important;
    background-color: var(--theme-deafult) !important;
    border-color: var(--theme-deafult) !important;
    padding: 0.375rem 0.75rem;
    display: inline-block;
    text-align: center;
    vertical-align: middle;
    cursor: pointer;
    border: 1px solid transparent;
    font-size: 1rem;
    line-height: 1.5;
    border-radius: 0.25rem;
    transition: color .15s ease-in-out,background-color .15s ease-in-out,border-color .15s ease-in-out,box-shadow .15s ease-in-out;
}

.swal2-confirm.btn.btn-primary:hover {
    background-color: var(--theme-deafult) !important;
    border-color: var(--theme-deafult) !important;
    opacity: 0.9;
}

/* Ensure modal content fits within viewport */
.modal-content {
    max-height: 90vh;
    overflow: hidden;
}

/* Make video container responsive */
.video-container {
    position: relative;
    padding-bottom: 56.25%;
    height: 0;
    overflow: hidden;
}

.video-container video {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: contain;
}
</style>
{% endblock %}